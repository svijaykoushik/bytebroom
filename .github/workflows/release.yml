name: ğŸš¢ Release Workflow

on:
  push:
    tags:
      - 'v*' # ğŸ·ï¸ Trigger on new tags like v1.0.0

permissions:
  contents: write # ğŸ“ Permission to write to the repository (needed for creating releases)

jobs:
  run-build:
    name: Run Build before Release ğŸ—ï¸
    uses: ./.github/workflows/build.yml # ğŸ”¨ Ensure build passes before releasing
    with:
      node-version: '20' # âœ¨ Use Node.js 20 for the build

  create-release:
    name: Create GitHub Release ğŸš€
    runs-on: ubuntu-22.04 # ğŸ§ Run on a recent Ubuntu version

    steps:
      - name: Create release from tag ğŸ‰
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # ğŸ”‘ Use GitHub token for authentication
          tag: ${{ github.ref_name }} # ğŸ”– Get the pushed tag name
        run: |
          gh release create "$tag" \
              --repo="$GITHUB_REPOSITORY" \
              --title="${tag#v}" \
              --generate-notes # ğŸ“ Create release notes automatically

      - name: Publish to npm
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish to GitHub Packages
        run: npm publish --registry=https://npm.pkg.github.com/
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
